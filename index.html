<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dicionário de tupi antigo: A língua indígena clássica do Brasil</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <main>
        <div class='content'>
            <div class='title'><h1>Dicionário de Tupi antigo</h1></div>
            <div class='subtitle'><h2>A língua indígena clássica do Brasil</h2></div>
                <div class='search_input'><input type="text" id="searchInput" placeholder="Digite a palavra a ser pesquisada" /></div>
                <div class='actions'>
                    <button class="search" id="searchButton">Pesquisar</button>
                </div>
            <section class='results' id="results">
                <ul></ul>
            </section>
        </div>
    </main>
    <div class='credits'>Dicionário por Eduardo de Almeida Navarro</div>
    <script>

        window.onload = async() => {
            resultsDiv.style.display = "none";
            const response = await fetch('dictionary.json')
            window.jsonData = await response.json()
        }
        function searchByFirstWord(data, query) {
            return data.filter(item => item.first_word.toLowerCase() === query.toLowerCase());
        }

        function searchAllDefinitions(data, query) {
            return data.filter(item => (item.first_word.toLowerCase() !== query.toLowerCase()) && item.definition.toLowerCase().includes(query.toLowerCase()));
        }

        // Function to remove diacritics from a string
        function removeDiacritics(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        function searchByFirstWordNoAccent(data, query) {
            const queryNormalized = removeDiacritics(query.toLowerCase());
            return data.filter(item => removeDiacritics(item.first_word.toLowerCase()) === queryNormalized);
        }

        function searchAllDefinitionsNoAccent(data, query) {
            const queryNormalized = removeDiacritics(query.toLowerCase());
            return data.filter(item => (removeDiacritics(item.first_word.toLowerCase()) !== queryNormalized) && removeDiacritics(item.definition.toLowerCase()).includes(queryNormalized));
        }

        const searchButton = document.getElementById("searchButton");
        const searchInput = document.getElementById("searchInput");
        const resultsDiv = document.getElementById("results");

        searchButton.addEventListener("click", performSearch);
        searchInput.addEventListener("keydown", function(event) {
            if (event.key === "Enter") {
                performSearch();
            }
        });

        window.addEventListener("load", function() {
            searchInput.focus();
            searchInput.click();
        });


        function performSearch() {
            const query = searchInput.value.trim().toLowerCase(); // Convert query to lowercase

            if (!query) {
                alert('Ops, é necessário preencher algo para pesquisar!')
                return;
            }

            const verbete_results_exact = searchByFirstWord(window.jsonData, query);
            const def_results_exact = searchAllDefinitions(window.jsonData, query);
            
            // Perform diacritic-insensitive searches
            const verbete_results_diacritic = searchByFirstWordNoAccent(window.jsonData, query);
            const def_results_diacritic = searchAllDefinitionsNoAccent(window.jsonData, query);
            
            // Combine and prioritize results
            const combinedResults = Array.from(new Set([...verbete_results_exact, ...verbete_results_diacritic, ...def_results_exact, ...def_results_diacritic]));
            // Add the 'exact_match' property based on source
            const results = combinedResults.map(result => {
                const sourceIsVerbete = verbete_results_exact.includes(result) || def_results_exact.includes(result);
                return {
                    ...result,
                    exact_match: sourceIsVerbete
                };
            });
            resultsDiv.innerHTML = ""; // Clear previous results
            resultsDiv.style.display = "block";

            if (results.length > 0) {
                results.forEach(result => {
                    const resultDiv = document.createElement("div");

                    // Case-insensitive highlighting of query word
                    const definition = result.definition.replace(new RegExp(`(${query})`, "ig"), '<span class="highlighted">$1</span>');
                    // Create a link with query parameter
                    const link = document.createElement("a");
                    link.href = `${window.location.pathname}?query=${encodeURIComponent(result.first_word)}`;
                    link.innerText = result.first_word;
                    link.classList.add("search-link");
                    
                    // Create superscript for optional_number
                    const optionalNumberSup = document.createElement("sup");
                    optionalNumberSup.innerText = result.optional_number;
                    link.appendChild(optionalNumberSup);

                    resultDiv.appendChild(link);
                    resultDiv.innerHTML += ` ${definition}`;
                    if (result.exact_match) {
                        resultDiv.classList.add("exact-match");
                    } else {
                        resultDiv.classList.add("approximate-match");
                    }
                    resultsDiv.appendChild(resultDiv);

                });
                const newUrl = `${window.location.pathname}?query=${encodeURIComponent(query)}`;
                history.pushState(null, null, newUrl);
            } else {
                resultsDiv.innerHTML = "Não foram encontrados resultados.";
            }
        }

        // Read query parameter from URL
        const urlParams = new URLSearchParams(window.location.search);
        const queryParam = urlParams.get('query');

        if (queryParam) {
            // Preload results based on the query parameter
            searchInput.value = queryParam;
            performSearch();
        }
    </script>
</body>
</html>
